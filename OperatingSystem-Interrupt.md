# 操作系统体系结构
## windows 体系结构
![](https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1580922432250&di=97f6e939d0b376cd489116302b086770&imgtype=0&src=http%3A%2F%2F5b0988e595225.cdn.sohucs.com%2Fimages%2F20171119%2Fe9893df56b72442cb3de88b1f912065d.jpeg)

- (kernel)内核：线程 中断等
- ( win32)子系统
- Ntdll.dll 负责上面的用户态调用
![](https://i.loli.net/2020/02/05/SucrTsvq59n1VRj.png)

## unix 架构
![](https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=828711790,4120883374&fm=26&gp=0.jpg)

## linux 内核组件
![](https://i.loli.net/2020/02/05/7Nm1R5IfsvnYPbd.png)

# 操作系统分类
## 传统分类
- 批处理操作系统
  - 单道
  - 多道
  - 一次执行多少道程序
  - spooling
    - 利用磁盘作为缓冲，将输入、计算、输出分别组织成独立的任务流，使I/O和计算真正并行
- 分时操作系统
  - 时间片
    - 操作系统将cpu时间划分为若干个片段，称为时间片
    - 以时间片为单位，轮流为每个终端用户吃梨
- 通用操作系统
  - 分时与批处理结合
- 实时操作系统
  - 及时响应外部事件的请求
  - 严格时间内要做响应
  - 高可靠性
- 个人计算机操作系统
  - 界面优化
  - 使用方便
- 网络操作系统
  - 网络管理 通信 安全
- 分布式操作系统
  - 以计算机网络为基础
  - 或多处理机为基础
  - 处理分布在不同计算机上
  - 是一个统一的操作系统
- 嵌入式操作系统
## Tenenbaum分类
- 智能卡操作系统
  - 严格运行能耗和储存空间的限制
  - 只有单项功能
# 操作系统运行环境 运行机制

## 系统调用机制
## 处理器状态（模式）
- 处理器由运算器 控制器 一系列的寄存器以及高速缓存构成
- 用户可见寄存器
  - 高级语言编译器通过优化算法分配并使用，以减少程序访问内存次数
- 控制和状态寄存器
  - 用于控制处理器的操作，通常有操作系统代码使用
  - 在某种特权级别下可以访问修改
  - 常见：
    - 程序计数器：记录将要取出的指令的地址
    - 指令寄存器：记录最近取出的指令
    - 程序状态字：记录CPU的运行状态与条件码，模式，控制位等信息
- 操作系统的需求--保护
  - 因为并发共享取用硬件，因此需要实现保护控制
  - 需要硬件提供基本运行机制
    - 能在不同的特权级运行的不同指令集合
    - 硬件机制可将os与用户程序隔离：操作系统可以访问用户空间，用户空间不可以访问操作系统空间
- 现代处理器通常将CPU状态设计划分为两种、三种或四种
- 在**程序状态字**中专门设置一位或两位，根据用户状态**对资源和指令的使用权限**进行设置不同的CPU状态
- 操作系统需要两个状态：用户态内核态
  - 特权指令 只能由操作系统使用，用户程序不能使用
  - 非特权指令 用户程序可以使用的指令
  - X86 4个特权级别：R0(内核态) R1 R2 R3（用户态）
## 中断与异常机制
  - 用户态进入内核态的唯一途径就是：**中断/异常/陷入机制**
  - 内核态进入用户态：**设置程序状态字PSW**
  - 特殊指令：陷入指令（又称访管指令 supervisor mode）
    - 提供给用户程序的接口，用于调用操作系统的功能（服务）
  - 主要作用
    - 处理设备发来的中断请求
    - 可以使os捕获用户程序提出的服务请求
    - 防止用户程序执行过程中的破坏性活动
  - 中断/异常 的概念
    - CPU对系统发生的**某个事件**做出的一种反应
      - CPU暂停正在执行的程序，保留现场后自动转去执行相应事件的处理程序，处理完成后返回断点继续执行被打断的程序
      - 特点：随机发生的 自动处理的 可恢复的 由硬件来完成
    - 中断的引入：为了支持CPU和设备之间的并行操作 （例如向CPU汇报IO完成）
    - 异常的引入：表示CPU执行指令时本身出现的问题
### 中断事件
- 事件
  - 中断（外中断）
    - IO中断
    - 时钟中断：定时器
    - 硬件故障：笔记本快没电了
  - 异常（内中断）
    - 系统调用
    - 页故障/页错误（缺少io资源）
    - 保护性异常 （只读）
    - 断点指令（调试）
    - 其他程序性异常（算数溢出等等）

类别 | 原因 | 异步/同步 | 返回行为
---|---|---|---|
中断|来自io设备、其他硬件部件|异步|总是返回下一条指令
陷入|有意识安排的|同步|返回到下一条指令
故障|可恢复的错误|同步|返回到当前指令
终止|不可恢复的错误|同步|不可返回
### 中断异常机制工作原理
- 硬件：捕获中断源发出的中断/异常请求，以一定的方式 **响应** 将处理器控制权交给特定的处理程序
- 软件：识别并完成相应**处理**
#### 中断响应
- 发现中团、接受中断的过程
- 全部由硬件来完成
- 处理器控制部件中 设有 中断寄存器
- CPU如何响应中断：
  ![](https://i.loli.net/2020/02/06/4cG2qFMpVPSsAa8.png)
  - 中断向量表
    - 其实就是一个内存单元 存放中断处理程序入口地址和程序运行时所需的处理机状态字
  - 硬件中断流程
  ![](https://i.loli.net/2020/02/06/C3mAEwtkdVQRPyi.png)
  - 软件流程
    - 硬件会保存关键信息，软件保存剩下的
    - 分析具体原因
    - 执行对应的处理功能
    - 恢复现场，返回被事件打断的程序
##### 小例子
  - 打印机
    - 打印机给CPU发中断信号（硬件）
    - CPU处理完当前指令后检测到中断，判断出中断来源并向相关设备发确认信号（硬件）
    - CPU开始为软件处理中断做准备（硬件）
    - 在系统栈中保存被中断程序的重要上下文环境，主要是pc程序计数器和psw程序状态字（硬件）
    - CPU根据中断码查询中断向量表，获得与该中断相关的处理程序的入口地址，并将pc设置成该地址，新的指令周期开始时，CPU控制转移到中断处理程序（硬件）
    - 中断处理程序开始工作
    - 在系统栈中保存现场信息（软件）
    - 检查io设备的状态信息，操纵io设备或者在设备和内存之间传送数据等等（软件）
    - 中断处理结束时，CPU检测到中断返回指令，从系统栈中回复被中断程序的上下文环境，CPU恢复成原来的状态，psw和pc恢复成中断之前的值，下一指令周期开始继续执行下面的的任务（硬件）
### X86处理器
- 中断
- 异常
  - 80*86 处理器发布了大约20种不同的异常
  - 对于某些异常，CPU会在执行异常处理程序之前产生
- 系统调用
  - 异常的一种，用户态到内核态的唯一入口
- 中断控制器
  - 负责将硬件的中断信号转换为中断向量，并应发CPU中断
- 实模式：中断向量表
  - 存放中断服务程序的入口地址
  - 入口地址 = 段地址左移4位+偏移地址
  - 没有CPU运行状态切换
  - 中断处理与一般过程调用很像
- 保护模式：中断描述符表
  - 采用门描述符数据结构表示中断向量
    - 任务门
    - 中断门
      - 给出断选择符，中断/异常程序的段内偏移量
      - 通过中断门后系统会自动禁止中断
    - 陷阱门
      - 与中断门类似，但通过陷阱门后系统不会总禁止中断
    - 调用门
## 系统调用
- 操作系统功能调用，给编程人员提供的
- 从用户态陷入内核态
- 应用程序可以直接调用系统调用
- 应用程序也可以调用c函数库/API接口 再由c函数库/API接口调用系统调用
### 系统调用的设计
- 中断/异常机制
  - 使之支持系统调用服务的实现
- 选择一条特殊指令  
  - 陷入指令（访管指令）完成用户态到内核态切换
- 系统调用号和参数
  - 每个系统调用都事先给定一个编号
- 系统调用表
  - 存放系统调用服务例程的入口地址

### 参数传递过程问题
- 怎样实现用户程序的参数传递给内核
  - 由陷入指令自带参数
    - 陷入指令的长度有限，且还要携带系统调用功能和，只能自带有限的参数
  - 通过通用寄存器传递参数
    - 这些寄存器是操作系统和用户程序都能访问的，但是寄存器的个数会限制传递参数的数量
  - 在内存中开辟专用堆栈区来传递参数
### 系统调用执行过程
- 中断/异常机制： 硬件保护现场;通过查询**中断向量表**，控制权转换给**系统调用总入口程序**
- 系统调用的总入口程序：保存现场 将参数保存在内核堆栈当中，通过查看**系统调用表**把控制权转给相应的**系统调用处理例程或内核函数**。
- 执行系统调用例程
- 回复现场，返回用户程序
### 中断发生后OS底层工作步骤
- **硬件**压栈：程序计数器等
- **硬件**从中断向量装入新的程序计数器等
- **汇编语言**过程保存寄存器值
- **汇编语言**过程设置新的堆栈
- **C语言**中断服务程序运行（例如：读并缓冲输入）
- **进程调度程序**决定下一个即将运行的进程
- **C语言**过程返回至汇编代码
- **汇编语言**过程开始运行新的当前进程
